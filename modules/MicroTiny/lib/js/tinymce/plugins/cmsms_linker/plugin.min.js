tinymce.PluginManager.add("cmsms_linker",function(e,t){function n(){function v(t){var n=[{text:cmsms_tiny.target_none,value:""}];if(!e.settings.target_list){n.push({text:cmsms_tiny.target_new_window,value:"_blank"})}tinymce.each(e.settings.target_list,function(e){n.push({text:e.text||e.title,value:e.value,selected:t===e.value})});return n}function m(e){$(".ui-autocomplete").css("z-index",7e4);$(".ui-helper-hidden-accessible").hide();var t=document.getElementById(e);$(t).autocomplete({minLength:2,source:function(e,t){$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{term:e.term},success:function(e){t(e)}})},focus:function(e,t){e.preventDefault()},select:function(e,n){$(t).val(n.item.label);$(".mce-cmsms-linker-alias").val(n.item.value);$(".mce-cmsms-linker-href").val("{cms_selflink href='"+n.item.value+"'}");e.preventDefault()}})}function g(){function f(){if(t.text!==o){if(s){e.focus();s.innerHTML=t.text;r.setAttribs(s,{href:i,target:t.target?t.target:null,rel:t.rel?t.rel:null,"class":t.classname?t.classname:null});n.select(s)}else{e.insertContent(r.createHTML("a",{href:i,target:t.target?t.target:null,rel:t.rel?t.rel:null,"class":t.classname?t.classname:null},t.text))}}else{e.execCommand("mceInsertLink",false,{href:i,target:t.target,rel:t.rel?t.rel:null,"class":t.classname?t.classname:null})}}var t=u.toJSON(),i=t.href,a=t.page;if(!i||!a){e.execCommand("unlink");return}f()}var t={},n=e.selection,r=e.dom,i,s,o,u,a,f,l,c,h,p,d;i=n.getNode();s=r.getParent(i,"a[href]");t.page="";t.alias="";t.text=o=s?s.innerText||s.textContent:n.getContent({format:"text"});t.href=s?r.getAttrib(s,"href"):"";t.target=s?r.getAttrib(s,"target"):"";t.classname=s?r.getAttrib(s,"class"):"";t.rel=s?r.getAttrib(s,"rel"):"";if(t.href.indexOf("cms_selflink")!==-1){d=t.href.match(/href=(.*)[\s\}]/);if(d.length>=2){t.alias=d[1].replace(/'/g,"");t.page=cmsms_tiny.loading_info;$.ajax({url:cmsms_tiny.linker_autocomplete_url,dataType:"json",data:{alias:t.alias},success:function(e){t.page=e.label;t.href="{cms_selflink href='"+t.alias+"'}";$(".mce-cmsms-linker-page").val(t.page);$(".mce-cmsms-linker-alias").val(t.alias);$(".mce-cmsms-linker-href").val(t.href)}})}}if(i.nodeName==="IMG"){t.text=o=" "}if(e.settings.target_list!==false){c={name:"target",type:"listbox",label:cmsms_tiny.prompt_target,values:v(t.target)}}a={name:"page",type:"textbox",size:40,classes:"cmsms-linker-page",tooltip:cmsms_tiny.prompt_page_info,label:cmsms_tiny.prompt_page,onkeyup:function(){m(this._id)},onchange:function(){m(this._id)}};f={name:"alias",disabled:true,type:"textbox",size:40,label:cmsms_tiny.prompt_alias,tooltip:cmsms_tiny.prompt_alias_info,classes:"cmsms-linker-alias"};l={name:"text",type:"textbox",size:40,label:cmsms_tiny.prompt_text,onchange:function(){t.text=this.value()},onkeyup:function(){t.text=this.value()}};h={name:"classname",type:"textbox",size:40,label:cmsms_tiny.prompt_class,onchange:function(){t.classname=this.value()},onkeyup:function(){t.classname=this.value()}};p={name:"rel",type:"textbox",size:40,label:cmsms_tiny.prompt_rel,onchange:function(){t.rel=this.value()},onkeyup:function(){t.rel=this.value()}};u=e.windowManager.open({title:cmsms_tiny.linker_text,data:t,bodyType:"tabpanel",body:[{title:cmsms_tiny.tab_general,type:"form",items:[a,f,l,{name:"href",type:"textbox",classes:"cmsms-linker-href",size:100,hidden:true,value:"{cms_selflink href='"+t.alias+"'}"}]},{title:cmsms_tiny.tab_advanced,type:"form",items:[c,h,p]}],onSubmit:g})}e.addButton("cmsms_linker",{title:cmsms_tiny.linker_title,icon:"link",image:cmsms_tiny.linker_image,onclick:n,stateSelector:"a[href]"});e.addMenuItem("cmsms_linker",{text:cmsms_tiny.linker_text,title:cmsms_tiny.linker_title,image:cmsms_tiny.linker_image,stateSelector:"a[href]",context:"insert",prependToContext:true,onclick:n})});